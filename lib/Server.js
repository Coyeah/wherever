"use strict";var e=require("path"),t=require("fs"),r=require("express"),a=require("chalk"),s=require("mime-types"),i=require("http-proxy-middleware"),o=require("ejs"),n=require("os"),l=require("child_process"),c=require("zlib");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var h=d(e),f=d(t),u=d(r),p=d(a),g=d(s),m=d(o),v={file:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-medical" viewBox="0 0 16 16"><path d="M7.5 5.5a.5.5 0 0 0-1 0v.634l-.549-.317a.5.5 0 1 0-.5.866L6 7l-.549.317a.5.5 0 1 0 .5.866l.549-.317V8.5a.5.5 0 1 0 1 0v-.634l.549.317a.5.5 0 1 0 .5-.866L8 7l.549-.317a.5.5 0 1 0-.5-.866l-.549.317V5.5zm-2 4.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zm0 2a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/><path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/></svg>',folder:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-folder" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z"/></svg>',back:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-backspace" viewBox="0 0 16 16"><path d="M5.83 5.146a.5.5 0 0 0 0 .708L7.975 8l-2.147 2.146a.5.5 0 0 0 .707.708l2.147-2.147 2.146 2.147a.5.5 0 0 0 .707-.708L9.39 8l2.146-2.146a.5.5 0 0 0-.707-.708L8.683 7.293 6.536 5.146a.5.5 0 0 0-.707 0z"/><path d="M13.683 1a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7.08a2 2 0 0 1-1.519-.698L.241 8.65a1 1 0 0 1 0-1.302L5.084 1.7A2 2 0 0 1 6.603 1h7.08zm-7.08 1a1 1 0 0 0-.76.35L1 8l4.844 5.65a1 1 0 0 0 .759.35h7.08a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1h-7.08z"/></svg>'};const w=n.networkInterfaces();const b={main:"index.html",hostname:function(){let e="";for(let t in w){let r=w[t];for(let t=0;t<r.length;t++){let a=r[t];"IPv4"!==a.family||"127.0.0.1"===a.address||a.internal||(e=a.address)}}return e}()||"127.0.0.1",port:3e3,root:"./",compress:/\.(html|js|css|md)/,historyApiFallback:"index.html"},x=process.cwd(),y=t.readFileSync(h.default.join(__dirname,"./dir.ejs"),"utf-8"),C=(e,t)=>{try{const r=e();null!=r&&(t=r)}catch(e){}return t},H={maxAge:600,expires:!0,cacheControl:!0,lastModified:!0,etag:!0};function $(e,t,r){!function(e,t){const{maxAge:r,expires:a,cacheControl:s,lastModified:i,etag:o}=H;a&&t.setHeader("Expires",new Date(Date.now()+1e3*r).toUTCString()),s&&t.setHeader("Cache-Control",`public, max-age=${r}`),i&&t.setHeader("Last-Modified",e.mtime.toUTCString()),o&&t.setHeader("ETag",`${e.size}-${e.mtime.toUTCString()}`)}(e,r);const a=t.headers["if-modified-since"],s=t.headers["is-none-match"];return!(!a&&!s)&&((!a||a===r.getHeader("Last-Modified"))&&(!s||s===r.getHeader("ETag")))}module.exports=class{static defaultConfig=b;constructor(e={}){const{port:r=b.port,root:a=b.root,config:s,open:i=!1,server:o=!1}=e,n=(e=>{if(!e)return{};const r=h.default.resolve(x,e);return C((()=>JSON.parse(t.readFileSync(r,"utf-8"))),{})})(s);this.app=u.default(),this.config=Object.assign({},b,{root:a,port:r,open:i,server:o},n),this.config.absoluteRoot=h.default.resolve(x,this.config.root)}start(e){this.reqLog(),this.proxyHandler(),this.methodGet(),this.listen(e)}reqLog(){this.app.use((function(e,t,r){console.info(p.default.whiteBright("[wherever]"),`${p.default.greenBright(`[${e.method}]`)}`,e.url),r()}))}proxyHandler(){const{proxy:e}=this.config;e&&"[object Object]"===e.toString()&&Object.keys(e).map((t=>{this.app.use(t,i.createProxyMiddleware(e[t].target,e[t]))}))}fileHandler(e,t,r){const{targetPath:a,stat:s}=r,i=g.default.lookup(a)||"text/plain";if(t.setHeader("Content-Type",`${i}; charset=utf-8`),$(s,e,t))return t.statusCode=304,void t.end();let o;const{code:n,start:l,end:d}=function(e,t,r){const a=t.headers.range;if(!a)return{code:200};const s=a.match(/bytes=(\d*)-(\d*)/),i=s[2]||e-1,o=s[1]||e-i;return o>i||o<0||i>e?{code:200}:(r.setHeader("Accept-Rangs","bytes"),r.setHeader("Content-Type",`bytes ${o}-${i}/${e}`),r.setHeader("Content-Length",i-o),{code:206,start:parseInt(o),end:parseInt(i)})}(s.size,e,t);200===n?(t.statusCode=200,o=f.default.createReadStream(a)):(t.statusCode=206,o=f.default.createReadStream(a,{start:l,end:d})),a.match(this.config.compress)&&(o=function(e,t,r){const a=t.headers["accept-encoding"];return a&&a.match(/\b(gzip|deflate)\b/)?a.match(/\bgzip\b/)?(r.setHeader("Content-Encoding","gzip"),e.pipe(c.createGzip())):a.match(/\deflate\b/)?(r.setHeader("Conten-Encoding","deflate"),e.pipe(c.createDeflate())):void 0:e}(o,e,t)),o.pipe(t)}notFound(e){e.statusCode=404,e.end()}listen(){this.app.listen(this.config.port,(()=>{const e=`http://${this.config.hostname}:${this.config.port}`,t=`http://localhost:${this.config.port}`;this.config.open&&(e=>{switch(process.platform){case"win32":l.exec(`start ${e}`);break;case"darwin":case"linux":default:l.exec(`open ${e}`)}})(e),console.info(),console.info(p.default.whiteBright("[wherever]"),"|",`Server started at ${p.default.green(e)}`),console.info("          ","|",`Server started at ${p.default.green(t)}`),console.info()}))}getStat(e){return new Promise(((t,r)=>{const a=C((()=>f.default.statSync(e)),null);a?t(a):r()}))}getFolderList(e){const t=f.default.readdirSync(e),r=[];for(let a of t)r.push(this.getStat(h.default.join(e,a)).then((e=>[e,a])));return Promise.all(r).then((e=>e.filter((e=>!!e)).map((([e,t])=>({filename:t,isFile:e.isFile(),isDirectory:e.isDirectory()})))))}methodGet(){const{absoluteRoot:e,server:t,historyApiFallback:r}=this.config;this.app.get("*",((a,s)=>{const i=h.default.resolve(e,a.url.slice(1));this.getStat(i).then((o=>{if(o.isFile())return this.fileHandler(a,s,{targetPath:i,stat:o});if(!t&&o.isDirectory()){const t=h.default.relative(e,i),r=[{filename:"/",path:"/",icon:v.back}];return t&&r.push({filename:"../",path:"/"+h.default.relative(e,h.default.resolve(i,"../")),icon:v.back}),this.getFolderList(i).then((e=>{const a=r;e.forEach((e=>{e.path=`${t?`/${t}`:""}/${e.filename}`,e.icon=e.isFile?v.file:v.folder,a.push(e)})),s.statusCode=200,s.setHeader("Content-Type","text/html; charset=utf-8"),s.end((e=>m.default.render(y,e))({files:a,title:"/"+t}))}))}if(t&&o.isDirectory()){const t=h.default.resolve(e,r);return this.getStat(t).then((e=>{e.isFile()&&this.fileHandler(a,s,{targetPath:t,stat:e})}))}return Promise.reject()})).catch((e=>{e instanceof Error&&console.error(p.default.redBright("[wherever]"),e.name+": ",e.message),this.notFound(s)}))}))}};
